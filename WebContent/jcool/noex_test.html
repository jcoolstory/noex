<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="lib/lib.js"></script>
<link rel="stylesheet" href="lib/canvas.css">
<script>
	if (window.File && window.FileReader && window.FileList && window.Blob) {
	} else {
		alert('The File APIs are not fully supported in this browser.');
	}
</script>
</head>
<body>
	<div class="container" id="drop_zone">
	<canvas id="view1" class="vcanvas" width="600" height="600"></canvas>
	<canvas id="overlayCanvas" class="vcanvas" width="600" height="600"></canvas>
	<div id="toolbar">toolbar</div>
	</div>
	<div class="layoutright">
		<h3><span id="infomation"></span></h3>
		<input type="file" id="inputbox" name="view1" onchange="readURL(this)"
			multiple="multiple" />
		<p>	<input type='radio' name='scalemode' id='scalefit' value='fit'/ checked> autofit
		<input type='radio' name='scalemode' id='scaleorigin' value='origin'/> 1:1</p>
		<p><button onclick="imagecrop()">Crop</button></p>
		<p><button onclick="imageorigin()">Origin</button></p>
		<p><button onclick="reflectionVertical()">Flip Vertical</button></p>
		<p><button onclick="reflectionHorizon()">Flip Horizon</button></p>
		<p><a href="#" id='saveFile' onclick="saveFile()" download="custom-filename.png">Save</a></p>
	</div>
	<br/>
</body>
<script>
	var maxImage = 1;
	var infomationText = document.getElementById('infomation');
	var toolbarText = document.getElementById('toolbar');
	var c = document.getElementById('view1');
	var oC = document.getElementById('overlayCanvas');
	var octx = oC.getContext("2d");
	var ctx = c.getContext("2d");
	var ir = null;
	var dropZone = document.getElementById('drop_zone')
 	var pressed = false;
	var dragmode = "move";
	var lpx=0;
	var lpy=0;
	var cropRect = new Rectangle();
	var dragged = false
	
	function refreshImage(name, src) {
	
		var img = src;		
		ir = new ImageRect();
		ir.x= 0;
		ir.y = 0;
		ir.width = ctx.canvas.width;
		ir.height = ctx.canvas.height;
		ir.image = img;
		infomationText.innerHTML = 'width : ' + ir.image.width +' px <br/>height : ' + ir.image.height + ' px'; 
		DrawImage(ir);
	}
	
	function DrawImage(image)
	{
		if (getMode() == 'fit')
			ir.draw();
		else
		{
			ctx.fillStyle = "#000000"
			ctx.fillRect(0,0,c.width,c.height);
			var offsetx = (c.width - image.image.width)/2;
			var offsety = (c.height - image.image.height)/2;
			ctx.drawImage(image.image, image.x,image.y,image.width,image.height,offsetx,offsety,image.width,image.height);
		}
	}
	
	function getMode()
	{
		if (document.getElementById('scalefit').checked == true)
			return "fit";
		if (document.getElementById('scaleorigin').checked == true)
			return "origin"
			
		return "fit";
	}
	
	function canvasMouseUp(evt){

		pressed = false;
		if (ir !=null)
			ir.pressed = false;
		if (!dragged)
			octx.clearRect(0,0,oC.width,oC.height);
		dragged = false;
	}
	
	function canvasMouseDown(evt){
		pressed = true;	
		lpx = evt.x;
		lpy = evt.y;
	}
	
	function canvasMouseOver(evt){
		
		if (!pressed)
			return;
		dragged = true;
		
		
		// select가 허용범위보다 크거나 작은것을 방
		var px = evt.x;
		var py = evt.y;
		if (px > c.width){
			px = c.width;
		}		
		if (py > c.height){					
			py = c.height;
		}		
		if (px < 0){
			px = 0;
		}		
		if (py < 0){
			py = 0;
		}		
		px = px-lpx;
		py = py-lpy;
		if (ir != null)
		{
			cropRect.x = lpx/c.width * ir.image.width;
			cropRect.y = lpy/c.height * ir.image.height;
			cropRect.width = px/c.width * ir.image.width;
			cropRect.height = py/c.height * ir.image.height;
		}

		octx.clearRect(0,0,c.width,c.height);
		octx.fillStyle ='rgba(30,30,30,0.8)'
		octx.fillRect(0, 0, oC.width, oC.height);
		octx.globalCompositeOperation = 'destination-out';
		octx.fillStyle = "black";
		octx.fillRect(lpx,lpy,px,py);
		
		octx.strokeStyle = 'rgba(255,0,0,1)';
		octx.fillStyle = 'rgba(150,150,255,0.3)'
		octx.lineWidth = 1;
	
		octx.globalCompositeOperation = "source-over"
		octx.strokeStyle = "lime"
		octx.rect(lpx,lpy,px,py);
		
		octx.stroke();
		octx.beginPath();
		
		toolbarText.innerHTML = '(' + lpx +',' + lpy + ')-(' + px +',' + py + ')'; 
	}
	
	function imagecrop(){
		if (ir == null)
			return;
		
		var xd = cropRect.x / ir.image.width;
		var srcX,srcY,srcW,srcH;
		if (getMode() == 'fit'){
			ctx.drawImage(ir.image, cropRect.x,cropRect.y,cropRect.width,cropRect.height,0,0,c.width,c.height);
			octx.clearRect(0,0,oC.width,oC.height);
		}
		else{
			ctx.fillRect(0,0,c.width,c.height);
			var offsetx = (c.width - cropRect.width)/2;
			var offsety = (c.height - cropRect.height)/2;
			ctx.drawImage(ir.image, cropRect.x+50,cropRect.y+50,cropRect.width,cropRect.height,offsetx,offsety,cropRect.width,cropRect.height);
			octx.clearRect(0,0,oC.width,oC.height);
		}
	}
	
	function imageorigin(){
	
		if (ir == null)
			return;
		DrawImage(ir);

		octx.clearRect(0,0,oC.width,oC.height);
	}
	
	function reflectionVertical(){
		if (ir == null)
			return;
			
		ctx.translate(0, c.height);
        ctx.scale(1, -1);
		ctx.drawImage(ir.image, 0,0,ir.image.width,ir.image.height,0,0,c.width,c.height);		
	}
	
	function reflectionHorizon(){
		if (ir == null)
			return;
			
		ctx.translate(c.width, 0);
        ctx.scale(-1, 1);
		ctx.drawImage(ir.image, 0,0,ir.image.width,ir.image.height,0,0,c.width,c.height);
	}
	
	function saveFile(){
		if (ir == null)
			return;
		
		var dataURL = c.toDataURL('image/png');
		var button = document.getElementById('saveFile');
		button.href = dataURL;
	}
	
	function handleFileSelect(evt) {
		evt.stopPropagation();
		evt.preventDefault();

		var files = evt.dataTransfer.files;
		readSub(0, files[0]);
	}

	function handleDragOver(evt) {
		evt.stopPropagation();
		evt.preventDefault();
		evt.dataTransfer.dropEffect = 'copy';
	}
	
	// Setup the dnd listeners. 
	dropZone.addEventListener('dragover', handleDragOver, false);
	dropZone.addEventListener('drop', handleFileSelect, false);
	dropZone.addEventListener('mousemove', canvasMouseOver ,false)
	dropZone.addEventListener('mousedown', canvasMouseDown ,false)
	dropZone.addEventListener('mouseup', canvasMouseUp ,false)	
</script>
</html>