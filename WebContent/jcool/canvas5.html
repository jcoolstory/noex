<!DOCTYPE html>
<html>
<script type="text/javascript" src="lib/lib.js"></script>

<link rel="stylesheet" href="lib/canvas.css">
<script>
	if (window.File && window.FileReader && window.FileList && window.Blob) {
	} else {
		alert('The File APIs are not fully supported in this browser.');
	}
</script>
<body>
	<div class="container" id="drop_zone">
	<div class="imageViewer">
	<canvas id="view1" class="vcanvas" width="400" height="400"></canvas></div>'
	</div>
	<div class="layoutright">
		<input type="file" id="inputbox" name="view1" onchange="readURL(this)"
			multiple="multiple" />
	</div>
	<br/>
	<input type='radio' name='dragmode' id='dragmove' value='move' checked/> move
	<br/>
	<input type='radio' name='dragmode' id='dragresize' value='resize' /> resize
	 <br/>
	<input type='radio' name='dragmode' id='drawline' value='line' checked/> line
	<br/>
	<input type='radio' name='dragmode' id='drawrect' value='rect' checked/> rect
	<br/>
</body>
<script>
	var maxImage = 1;
	var c = document.getElementById('view1');
	var ctx = c.getContext("2d");
	var ir = null;
	var dropZone = document.getElementById('drop_zone')
 	var canvasview = document.getElementById('view1')
 	var pressed = false;
	var resize = false;
	var dragmode = "move";
	var lpx=0;
	var lpy=0;
	
	var ImageRect = function(){
		
		this.x = 0;
		this.y = 0;
		this.width = 0;
		this.height = 0;
		this.image = null;
		this.pressed = false;
		this.offsetx = 0;
		this.offsety= 0;
		
		this.draw = function(){
			ctx.drawImage(this.image, this.x,this.y,this.width,this.height);
		}
	}
	
	function getMode()
	{
		if (document.getElementById('dragmove').checked == true)
			return "move";
		if (document.getElementById('dragresize').checked == true)
			return "resize"
			
		return "move";
	}
	
	function refreshImage(name, src) {
	
		var img = src;		
		ir = new ImageRect();
		ir.x= c.width/4 
		ir.y = c.height/4
		ir.width = ctx.canvas.width/2
		ir.height = ctx.canvas.height/2;
		ir.image = img;
		
		ir.draw();
	}
	
	function canvasMouseUp(evt){
		pressed = false;	
		resize = false;
		if (ir !=null)
			ir.pressed = false;
	}
	
	function canvasMouseDown(evt){
		pressed = true;
		
		if (ir !=null && evt.x > ir.x && evt.x < ir.x + ir.width && evt.y > ir.y && evt.y < ir.y + ir.height){
			dragmode= getMode();
			
			if (dragmode == "resize")
			{
				resize = true;
				
				lpx = evt.x;
				lpy = evt.y;
			}
			else if (dragmode =="move")
			{
				ir.pressed= true;
				ir.offsetx = ir.x - evt.x;
				ir.offsety = ir.y - evt.y;
			}
		}
	}
	
	function canvasMouseOver(evt){
		if (ir == null)
			return;
		if (pressed){
			if (ir.pressed){
				ctx.clearRect(ir.x,ir.y,ir.width,ir.height);
				ir.x = evt.x + ir.offsetx;
				ir.y = evt.y + ir.offsety;
				
				ir.draw();
			}
			if (resize){
				ctx.clearRect(ir.x,ir.y,ir.width,ir.height);
				
				ir.width += (evt.x -lpx );
				ir.height += (evt.y -lpy );
				lpx = evt.x;
				lpy = evt.y;
				ir.draw();
			}
		}
	}
	function handleFileSelect(evt) {
		evt.stopPropagation();
		evt.preventDefault();

		var files = evt.dataTransfer.files; // FileList object.
		readSub(0, files[0]);
	}

	function handleDragOver(evt) {
		evt.stopPropagation();
		evt.preventDefault();
		evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
	}
	
	// Setup the dnd listeners. 
	dropZone.addEventListener('dragover', handleDragOver, false);
	dropZone.addEventListener('drop', handleFileSelect, false);
	canvasview.addEventListener('mousemove', canvasMouseOver ,false)
	canvasview.addEventListener('mousedown', canvasMouseDown ,false)
	canvasview.addEventListener('mouseup', canvasMouseUp ,false)	
</script>
</html>

